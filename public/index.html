<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Space Rocket Racer</title>
    <style>
        body { margin: 0; overflow: hidden; background: #0b0d17; color: white; font-family: sans-serif; }
        canvas { display: block; }
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; justify-content: center; align-items: center; }
        .menu-box { pointer-events: auto; background: rgba(20,20,30,0.95); padding: 30px; border: 2px solid #00d2ff; text-align: center; border-radius: 10px; display: none; box-shadow: 0 0 20px rgba(0,210,255,0.2); }
        .visible { display: block; }
        button { background: #00d2ff; border: none; padding: 10px 20px; color: #000; font-weight: bold; cursor: pointer; margin: 5px; font-size: 16px; transition: 0.2s; }
        button:hover { background: #fff; transform: scale(1.05); }
        input { padding: 10px; font-size: 16px; text-transform: uppercase; background: #000; color: #fff; border: 1px solid #444; }
        .hud { position: absolute; top: 10px; left: 10px; font-size: 18px; font-weight: bold; color: #00d2ff; pointer-events: none; text-shadow: 1px 1px 0 #000; }
        .controls-hint { position: absolute; bottom: 20px; width: 100%; text-align: center; color: #666; font-size: 14px; pointer-events: none; }
    </style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div class="hud">
    Points: <span id="scoreDisplay">0</span> | 
    Speed Lvl: <span id="speedLvl">1</span> | 
    Handle Lvl: <span id="handleLvl">1</span>
</div>

<div class="controls-hint">
    Controls: WASD or ARROWS to Move | SPACE to Brake
</div>

<div id="ui">
    <div id="mainMenu" class="menu-box visible">
        <h1 style="color:#00d2ff; margin-top:0;">ROCKET RACER</h1>
        <p>Use WASD/Arrows to Drive. Space to Brake.</p>
        <button onclick="setupSinglePlayer()">Single Player</button>
        <button onclick="showMenu('multiplayerMenu')">Multiplayer</button>
        <button onclick="showMenu('shopMenu')">Upgrade Shop</button>
    </div>

    <div id="multiplayerMenu" class="menu-box">
        <h2>Multiplayer</h2>
        <button onclick="createRoom()">Create Room</button>
        <br><br>
        <input id="roomCodeInput" placeholder="Enter Code">
        <button onclick="joinRoom()">Join</button>
        <br><br>
        <button onclick="showMenu('mainMenu')" style="background:#555; color:white;">Back</button>
    </div>

    <div id="lobbyMenu" class="menu-box">
        <h2>Room: <span id="lobbyCode" style="color:#ffee00;"></span></h2>
        <p>Waiting for host to start...</p>
        <div id="playerList" style="margin-bottom:20px;"></div>
        <button id="startBtn" style="display:none;" onclick="requestStart()">START RACE</button>
    </div>

    <div id="shopMenu" class="menu-box">
        <h2>Upgrade Hangar</h2>
        <p>Current Points: <span id="shopPoints">0</span></p>
        <div style="margin: 10px 0;">
            <button onclick="buyUpgrade('speed')">Engine (100 pts)</button>
        </div>
        <div style="margin: 10px 0;">
            <button onclick="buyUpgrade('handling')">Handling (100 pts)</button>
        </div>
        <br>
        <button onclick="showMenu('mainMenu')" style="background:#555; color:white;">Back</button>
    </div>

    <div id="gameOverMenu" class="menu-box">
        <h1>FINISHED!</h1>
        <h2 id="resultText" style="color:#ffee00;"></h2>
        <p>Points Earned: <span id="earnedPoints">0</span></p>
        <button onclick="showMenu('mainMenu')">Main Menu</button>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const socket = io();

    // Game State
    let width, height;
    let gameState = 'menu'; 
    let roomCode = null;
    let isHost = false;
    let opponents = {};
    
    // Player Stats
    let stats = {
        points: parseInt(localStorage.getItem('rr_points')) || 0,
        speedLvl: parseInt(localStorage.getItem('rr_speed')) || 1,
        handleLvl: parseInt(localStorage.getItem('rr_handle')) || 1
    };

    // Physics Variables
    let player = {
        x: 0, y: 0,
        vx: 0, vy: 0,
        angle: 0,
        currentPlanetIndex: 0
    };

    let track = [];
    let camera = { x: 0, y: 0 };
    
    // NEW: Key State Tracker
    let keys = {
        up: false,
        down: false,
        left: false,
        right: false,
        brake: false
    };

    // --- SETUP & INPUT ---
    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // Input Listeners
    window.addEventListener('keydown', (e) => {
        if(e.code === 'ArrowUp' || e.code === 'KeyW') keys.up = true;
        if(e.code === 'ArrowDown' || e.code === 'KeyS') keys.down = true;
        if(e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = true;
        if(e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = true;
        if(e.code === 'Space') keys.brake = true;
    });

    window.addEventListener('keyup', (e) => {
        if(e.code === 'ArrowUp' || e.code === 'KeyW') keys.up = false;
        if(e.code === 'ArrowDown' || e.code === 'KeyS') keys.down = false;
        if(e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = false;
        if(e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = false;
        if(e.code === 'Space') keys.brake = false;
    });

    function updateUI() {
        document.getElementById('scoreDisplay').innerText = stats.points;
        document.getElementById('shopPoints').innerText = stats.points;
        document.getElementById('speedLvl').innerText = stats.speedLvl;
        document.getElementById('handleLvl').innerText = stats.handleLvl;
    }
    updateUI();

    function gameLoop() {
        // Clear screen
        ctx.fillStyle = '#0b0d17';
        ctx.fillRect(0, 0, width, height);

        if (gameState === 'playing') {
            updatePhysics();
            drawGame();
            
            if(roomCode) {
                socket.emit('playerMove', { 
                    room: roomCode, 
                    x: player.x, 
                    y: player.y, 
                    angle: player.angle 
                });
            }
        }

        requestAnimationFrame(gameLoop);
    }
    requestAnimationFrame(gameLoop);

    // --- PHYSICS ENGINE ---

    function updatePhysics() {
        // Stats
        const maxSpeed = 6 + (stats.speedLvl * 1.5);
        const turnSpeed = 0.04 + (stats.handleLvl * 0.005);
        const acceleration = 0.15 + (stats.speedLvl * 0.02);

        // 1. Rotation (A/D or Left/Right)
        if(keys.left) player.angle -= turnSpeed;
        if(keys.right) player.angle += turnSpeed;

        // 2. Thrust (W/Up)
        if(keys.up) {
            player.vx += Math.cos(player.angle) * acceleration;
            player.vy += Math.sin(player.angle) * acceleration;
            
            // Generate simple particles for engine
            if(Math.random() > 0.5) createParticle(player.x, player.y, player.angle);
        }

        // 3. Reverse/Back (S/Down) - weaker than forward
        if(keys.down) {
            player.vx -= Math.cos(player.angle) * (acceleration * 0.5);
            player.vy -= Math.sin(player.angle) * (acceleration * 0.5);
        }

        // 4. Braking (Space)
        if (keys.brake) {
            player.vx *= 0.92; // Strong deceleration
            player.vy *= 0.92;
        } else {
            player.vx *= 0.99; // Natural space friction (drift)
            player.vy *= 0.99;
        }

        // Cap speed
        let speed = Math.sqrt(player.vx*player.vx + player.vy*player.vy);
        if (speed > maxSpeed) {
            let ratio = maxSpeed / speed;
            player.vx *= ratio;
            player.vy *= ratio;
        }

        player.x += player.vx;
        player.y += player.vy;

        // Camera Follow
        camera.x = player.x - width/2;
        camera.y = player.y - height/2;

        // Check Checkpoints
        if (track.length > 0) {
            let target = track[player.currentPlanetIndex];
            let dist = Math.hypot(player.x - target.x, player.y - target.y);
            
            if (dist < target.radius + 30) {
                if (player.currentPlanetIndex < track.length - 1) {
                    player.currentPlanetIndex++;
                } else {
                    finishRace();
                }
            }
        }
    }

    // Simple particle system
    let particles = [];
    function createParticle(x, y, angle) {
        // Offset to back of ship
        const px = x - Math.cos(angle) * 20;
        const py = y - Math.sin(angle) * 20;
        particles.push({
            x: px, y: py,
            life: 1.0,
            vx: (Math.random() - 0.5) * 2,
            vy: (Math.random() - 0.5) * 2
        });
    }

    function drawGame() {
        ctx.save();
        ctx.translate(-camera.x, -camera.y);

        // Draw Stars
        ctx.fillStyle = 'white';
        for(let i=0; i<100; i++) {
            ctx.fillRect(((i*137)%2000 + player.x*0.1), ((i*94)%2000 + player.y*0.1), 2, 2);
        }

        // Draw Particles
        for(let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.life -= 0.05;
            if(p.life <= 0) {
                particles.splice(i, 1);
            } else {
                ctx.fillStyle = `rgba(255, 165, 0, ${p.life})`;
                ctx.fillRect(p.x, p.y, 4, 4);
            }
        }

        // Draw Track
        track.forEach((p, index) => {
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
            ctx.fillStyle = p.color;
            ctx.fill();
            
            if(index === player.currentPlanetIndex) {
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 5;
                ctx.stroke();
            }
            if(p.isFinish) {
                ctx.fillStyle = 'white';
                ctx.font = "20px Arial";
                ctx.fillText("FINISH", p.x - 30, p.y + 5);
            }
        });

        // Draw Opponents
        for (let id in opponents) {
            if(id === socket.id) continue;
            let op = opponents[id];
            drawRocket(op.x, op.y, op.angle, '#ff4444');
        }

        // Draw Player
        drawRocket(player.x, player.y, player.angle, '#00d2ff');

        // Draw Arrow
        if(track[player.currentPlanetIndex]) {
            let t = track[player.currentPlanetIndex];
            let a = Math.atan2(t.y - player.y, t.x - player.x);
            let arrowDist = 120;
            ctx.fillStyle = '#ff0';
            ctx.beginPath();
            ctx.arc(player.x + Math.cos(a)*arrowDist, player.y + Math.sin(a)*arrowDist, 8, 0, Math.PI*2);
            ctx.fill();
        }

        ctx.restore();
    }

    function drawRocket(x, y, angle, color) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(angle);
        
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.moveTo(20, 0);
        ctx.lineTo(-15, 12);
        ctx.lineTo(-10, 0);
        ctx.lineTo(-15, -12);
        ctx.fill();
        
        // Thrust flame visual if accelerating
        if(keys.up && color === '#00d2ff') {
            ctx.fillStyle = '#ffaa00';
            ctx.beginPath();
            ctx.moveTo(-15, 6);
            ctx.lineTo(-35 - Math.random()*10, 0);
            ctx.lineTo(-15, -6);
            ctx.fill();
        }

        ctx.restore();
    }

    // --- MENUS & LOGIC (Identical to previous) ---
    function showMenu(id) {
        document.querySelectorAll('.menu-box').forEach(el => el.classList.remove('visible'));
        if(id) document.getElementById(id).classList.add('visible');
    }

    function setupSinglePlayer() {
        track = [];
        let startX = 400, startY = 300;
        for (let i = 0; i < 15; i++) {
            track.push({
                x: startX, y: startY,
                radius: 40 + Math.random()*20, 
                color: `hsl(${Math.random()*360}, 70%, 40%)`, 
                isFinish: i===14
            });
            startX += (Math.random() - 0.5) * 1200;
            startY -= (600 + Math.random() * 200);
        }
        startGame(track);
    }

    function startGame(trackData) {
        track = trackData;
        player.x = track[0].x;
        player.y = track[0].y;
        player.vx = 0; player.vy = 0;
        player.angle = -Math.PI / 2; // Point up
        player.currentPlanetIndex = 1;
        gameState = 'playing';
        showMenu(null);
    }

    function finishRace() {
        gameState = 'finished';
        if (roomCode) {
            socket.emit('playerFinished', roomCode);
        } else {
            endGameScreen(1);
        }
    }

    function endGameScreen(rank) {
        let earned = 0;
        if(rank === 1) earned = 200;
        else if(rank === 2) earned = 100;
        else earned = 50;

        stats.points += earned;
        saveStats();
        
        document.getElementById('resultText').innerText = rank + (rank===1?"st":rank===2?"nd":"th") + " Place!";
        document.getElementById('earnedPoints').innerText = earned;
        showMenu('gameOverMenu');
        roomCode = null;
    }

    function buyUpgrade(type) {
        if(stats.points >= 100) {
            stats.points -= 100;
            if(type === 'speed') stats.speedLvl++;
            if(type === 'handling') stats.handleLvl++;
            saveStats();
        } else {
            alert("Not enough points!");
        }
    }

    function saveStats() {
        localStorage.setItem('rr_points', stats.points);
        localStorage.setItem('rr_speed', stats.speedLvl);
        localStorage.setItem('rr_handle', stats.handleLvl);
        updateUI();
    }

    function createRoom() { socket.emit('createRoom'); }
    function joinRoom() { socket.emit('joinRoom', document.getElementById('roomCodeInput').value.toUpperCase()); }
    function requestStart() { if(roomCode && isHost) socket.emit('startGame', roomCode); }

    socket.on('roomCreated', (code) => {
        roomCode = code; isHost = true;
        document.getElementById('lobbyCode').innerText = code;
        document.getElementById('startBtn').style.display = 'inline-block';
        showMenu('lobbyMenu');
    });

    socket.on('roomJoined', (data) => {
        roomCode = data.code; isHost = false; track = data.track;
        document.getElementById('lobbyCode').innerText = data.code;
        document.getElementById('startBtn').style.display = 'none';
        showMenu('lobbyMenu');
    });

    socket.on('updateLobby', (players) => {
        document.getElementById('playerList').innerHTML = Object.keys(players).map(id => 
            `<div style="padding:5px; border-bottom:1px solid #333;">Pilot ${id.substr(0,4)}</div>`
        ).join('');
    });

    socket.on('gameStart', (serverTrack) => { startGame(serverTrack); });
    socket.on('playerMoved', (data) => { opponents[data.id] = data; });
    socket.on('gameOver', (rank) => { if(gameState === 'finished') endGameScreen(rank); });
    socket.on('errorMsg', (msg) => alert(msg));

</script>
</body>
</html>
